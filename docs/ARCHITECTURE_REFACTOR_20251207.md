# GravAIty æž¶æž„é‡æž„æ€»ç»“ (2025-12-07)

## ðŸ“‹ éœ€æ±‚èƒŒæ™¯

### æ ¸å¿ƒé—®é¢˜
1. **æ¸²æŸ“ä¸ä¸€è‡´**: å®žæ—¶æµå¼æ˜¾ç¤º 6 ä¸ªèŠ‚ç‚¹,åˆ·æ–°åŽæ˜¾ç¤º 10 ä¸ªèŠ‚ç‚¹(åŒ…å«å†…éƒ¨ LangSmith èŠ‚ç‚¹)
2. **æ—¶é—´æˆ³é”™è¯¯**: åˆ·æ–°åŽæ‰€æœ‰æ¶ˆæ¯æ—¶é—´æˆ³é‡ç½®ä¸ºå½“å‰æ—¶é—´,åŽ†å²æ•°æ®ä¸¢å¤±
3. **æž¶æž„å¤æ‚**: å‰ç«¯ä¾èµ– LangSmith Trace API é‡æž„åŽ†å²æ•°æ®,é€»è¾‘å¤æ‚æ˜“å‡ºé”™
4. **ä¸­é—´ç»“æžœè¦†ç›–**: Generate èŠ‚ç‚¹çš„æœ€ç»ˆç­”æ¡ˆä¼šè¦†ç›–ä¹‹å‰è½®æ¬¡çš„å¯¹è¯

### è®¾è®¡ç†å¿µ
- **ç®€åŒ–æž¶æž„**: å‰ç«¯ä¸ä¾èµ– LangSmith,ä½¿ç”¨æ•°æ®åº“æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€çœŸå®žæ¥æº
- **å®žæ—¶ä¸ŽåŽ†å²åˆ†ç¦»**: å®žæ—¶æ˜¾ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹,åŽ†å²åªæ˜¾ç¤ºç”¨æˆ·/åŠ©æ‰‹å¯¹è¯
- **ç²¾å‡†æ—¶é—´ç®¡ç†**: æ•°æ®åº“å€¼æ°¸è¿œå‡†ç¡®,å®žæ—¶æ¶ˆæ¯ä½¿ç”¨ `Date.now()`
- **è½»é‡çº§é»˜è®¤**: åŽ†å²åŠ è½½ä½¿ç”¨è½»é‡æŽ¥å£,æŒ‰éœ€æŸ¥è¯¢ Trace è¯¦æƒ…

---

## ðŸ”§ æŠ€æœ¯å®žçŽ°

### 1. åŽç«¯æ”¹é€ 

#### 1.1 æµå¼æ¨¡å¼ç®€åŒ–
```python
# ä»Žå•æ¨¡å¼æ”¹ä¸ºæ··åˆæ¨¡å¼
stream_mode=["updates", "messages", "custom"]

# åªå‘å¸ƒå…³é”®äº‹ä»¶
- messages æ¨¡å¼: LLM token æµå¼è¾“å‡º
- updates æ¨¡å¼: èŠ‚ç‚¹å®Œæˆäº‹ä»¶(ç§»é™¤ start äº‹ä»¶)
- custom æ¨¡å¼: é¢„ç•™è‡ªå®šä¹‰è¿›åº¦æç¤º(æœªæ¥å¯ç”¨)
```

#### 1.2 æŽ¥å£èŒè´£åˆ†ç¦»
```python
# è½»é‡çº§æŽ¥å£ - å‰ç«¯é»˜è®¤ä½¿ç”¨
GET /threads/{thread_id}/history
- åªè¿”å›ž user/assistant æ¶ˆæ¯
- ä¸æŸ¥è¯¢ LangSmith API
- ä½¿ç”¨æ•°æ®åº“åŽŸå§‹æ—¶é—´æˆ³(ç§’â†’æ¯«ç§’)

# å®Œæ•´æŽ¥å£ - æŒ‰éœ€æŸ¥è¯¢
GET /threads/{thread_id}/history-with-trace
- è¿”å›žå®Œæ•´ Trace æ ‘å’Œç»Ÿè®¡ä¿¡æ¯
- ç”¨äºŽè°ƒè¯•ã€æ€§èƒ½åˆ†æžã€Token ç»Ÿè®¡
- å‰ç«¯å¯é€‰æ‹©æ€§ä½¿ç”¨
```

#### 1.3 ç§»é™¤ç¼“å­˜ä¾èµ–
- åˆ é™¤ `utils.trace_cache` æ¨¡å—
- ç®€åŒ– LangSmith æŸ¥è¯¢é€»è¾‘
- ç›´æŽ¥æŸ¥è¯¢ä¸ç¼“å­˜,æŒ‰éœ€ä½¿ç”¨

---

### 2. å‰ç«¯é‡æž„

#### 2.1 åŽ†å²åŠ è½½ç®€åŒ–
**ç§»é™¤**:
- 150+ è¡Œ LangSmith Trace æ ‘å¤„ç†é€»è¾‘
- `flattenTree()` é€’å½’å±•å¹³å‡½æ•°
- `KEY_NODES` è¿‡æ»¤é€»è¾‘
- å¤æ‚çš„æ—¶é—´æˆ³é‡æ–°è®¡ç®—

**ä¿ç•™**:
```typescript
// ç›´æŽ¥åŠ è½½æ¶ˆæ¯,ä½¿ç”¨æ•°æ®åº“æ—¶é—´æˆ³
data.messages.forEach((msg: any) => {
  const timestamp = msg.timestamp 
    ? msg.timestamp * 1000  // æ•°æ®åº“å€¼(ç§’â†’æ¯«ç§’)
    : Date.now() - ...;     // é™çº§æ–¹æ¡ˆ
  
  if (msg.role === 'user' || msg.role === 'assistant') {
    reconstructedMessages.push({...});
  }
});
```

#### 2.2 å®žæ—¶æµå¼å¤„ç†ä¼˜åŒ–
**æ ¸å¿ƒä¿®å¤**: Generate èŠ‚ç‚¹è¦†ç›–é—®é¢˜
```typescript
if (nodeName === "generate") {
  // æ‰¾åˆ°æœ€åŽä¸€ä¸ª user æ¶ˆæ¯çš„ä½ç½®
  let lastUserIdx = -1;
  for (let i = prev.length - 1; i >= 0; i--) {
    if (prev[i].role === "user") {
      lastUserIdx = i;
      break;
    }
  }
  
  // åªç§»é™¤å½“å‰è½®æ¬¡çš„ä¸´æ—¶ assistant æ¶ˆæ¯
  const filteredMessages = prev.filter((msg, idx) => {
    if (msg.role !== "assistant") return true;
    if (idx <= lastUserIdx) return true; // ä¿ç•™åŽ†å²å¯¹è¯
    if (msg.nodeName === "generate") return true;
    return false; // ç§»é™¤ query_or_respond ä¸­é—´ç»“æžœ
  });
  
  // åˆ›å»º/æ›´æ–° generate æ¶ˆæ¯...
}
```

**å…³é”®ç‚¹**:
- æ‰¾åˆ°æœ€åŽä¸€ä¸ª user æ¶ˆæ¯è¾¹ç•Œ
- åªå¤„ç†å½“å‰è½®æ¬¡,ä¸å½±å“åŽ†å²å¯¹è¯
- ä¿ç•™æ‰€æœ‰ `nodeName="generate"` çš„æœ€ç»ˆç­”æ¡ˆ

#### 2.3 Turn ç»„ç»‡é€»è¾‘é‡å†™
**ç§»é™¤**: åŸºäºŽç´¢å¼•çš„é”™è¯¯åˆ†é…
```typescript
// âŒ é”™è¯¯: å‡åˆ†å‡è®¾å¯¼è‡´èŠ‚ç‚¹åˆ†é…é”™è¯¯
const startIdx = i * (nodeMessages.length / userMessages.length);
```

**ä½¿ç”¨**: åŸºäºŽæ—¶é—´æˆ³çš„ç²¾ç¡®è¿‡æ»¤
```typescript
// âœ… æ­£ç¡®: æ ¹æ®æ—¶é—´èŒƒå›´åˆ†é…èŠ‚ç‚¹
const turnNodeMessages = nodeMessages.filter(msg => 
  msg.timestamp >= userMsg.timestamp && 
  msg.timestamp < nextUserMsg.timestamp
);
```

#### 2.4 çŠ¶æ€ç®¡ç†ç®€åŒ–
**ç§»é™¤**:
- `traceStats` çŠ¶æ€(3 å¤„)
- `TraceStats` ç±»åž‹å®šä¹‰
- Trace ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºç»„ä»¶

**ä¿ç•™**:
- åŸºç¡€æ¶ˆæ¯çŠ¶æ€
- èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€
- WebSocket è¿žæŽ¥çŠ¶æ€

---

## ðŸ“Š æ•ˆæžœå¯¹æ¯”

### ä»£ç é‡å˜åŒ–
| æ¨¡å— | ä¿®æ”¹å‰ | ä¿®æ”¹åŽ | å˜åŒ– |
|------|--------|--------|------|
| åŽç«¯ chat.py | ~300 è¡Œ | ~280 è¡Œ | -20 è¡Œ |
| å‰ç«¯ useChatStream.ts | ~700 è¡Œ | ~570 è¡Œ | -130 è¡Œ |
| å‰ç«¯ ChatWindow.tsx | ~280 è¡Œ | ~250 è¡Œ | -30 è¡Œ |
| å‰ç«¯ TurnView.tsx | ~140 è¡Œ | ~90 è¡Œ | -50 è¡Œ |
| **æ€»è®¡** | **~1420 è¡Œ** | **~1190 è¡Œ** | **-230 è¡Œ** |

### æ€§èƒ½ä¼˜åŒ–
- **åŽ†å²åŠ è½½**: ä¸æŸ¥è¯¢ LangSmith API,å“åº”æ—¶é—´ä»Ž ~500ms é™è‡³ ~50ms
- **å®žæ—¶æ¸²æŸ“**: ç§»é™¤å¤æ‚è¿‡æ»¤é€»è¾‘,æ¸²æŸ“æ›´æµç•…
- **å†…å­˜å ç”¨**: å‡å°‘ Trace æ•°æ®ç¼“å­˜,é™ä½Žå†…å­˜åŽ‹åŠ›

### å¯ç»´æŠ¤æ€§æå‡
- **æž¶æž„æ¸…æ™°**: å®žæ—¶ä¸ŽåŽ†å²åˆ†ç¦»,èŒè´£æ˜Žç¡®
- **ä¾èµ–ç®€åŒ–**: å‰ç«¯ä¸ä¾èµ– LangSmith,é™ä½Žè€¦åˆ
- **æ—¶é—´å‡†ç¡®**: å•ä¸€æ•°æ®æº,é¿å…æ—¶é—´æˆ³ä¸ä¸€è‡´
- **é”™è¯¯å‡å°‘**: ç§»é™¤å¤æ‚é€»è¾‘,å‡å°‘ bug é£Žé™©

---

## ðŸŽ¯ æ ¸å¿ƒè®¾è®¡åŽŸåˆ™

### 1. å•ä¸€æ•°æ®æº (Single Source of Truth)
- **æ•°æ®åº“æ—¶é—´æˆ³æ˜¯å”¯ä¸€çœŸå®žæ¥æº**
- åŽ†å²æ¶ˆæ¯æ°¸è¿œä½¿ç”¨æ•°æ®åº“å€¼(`timestamp * 1000`)
- å®žæ—¶æ¶ˆæ¯ä½¿ç”¨ `Date.now()`,ä½†ä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“

### 2. èŒè´£åˆ†ç¦» (Separation of Concerns)
- **å®žæ—¶æ˜¾ç¤º**: å±•ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹,æ–¹ä¾¿ç”¨æˆ·ç†è§£ AI "æ€è€ƒ"è¿‡ç¨‹
- **åŽ†å²åŠ è½½**: åªæ˜¾ç¤ºå¯¹è¯å†…å®¹,ä¿æŒç•Œé¢ç®€æ´
- **Trace æŸ¥è¯¢**: æŒ‰éœ€èŽ·å–,ç”¨äºŽè°ƒè¯•å’Œåˆ†æž

### 3. æ€§èƒ½ä¼˜å…ˆ (Performance First)
- **è½»é‡çº§é»˜è®¤**: åŽ†å²åŠ è½½ä¸æŸ¥è¯¢ LangSmith
- **æŒ‰éœ€æŸ¥è¯¢**: Trace ä¿¡æ¯åªåœ¨éœ€è¦æ—¶èŽ·å–
- **æµå¼ä¼˜åŒ–**: å®žæ—¶æ¸²æŸ“ä½¿ç”¨å¢žé‡æ›´æ–°

### 4. ç”¨æˆ·ä½“éªŒä¼˜å…ˆ (UX First)
- **å®žæ—¶åé¦ˆ**: æ˜¾ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹,ç”¨æˆ·çŸ¥é“ AI åœ¨åšä»€ä¹ˆ
- **æ¸…æ™°å¯¹è¯**: åŽ†å²åªæ˜¾ç¤ºå¯¹è¯,é¿å…æŠ€æœ¯ç»†èŠ‚å¹²æ‰°
- **æ—¶é—´å‡†ç¡®**: åˆ·æ–°åŽæ—¶é—´æˆ³ä¿æŒä¸å˜,ç¬¦åˆç”¨æˆ·é¢„æœŸ

---

## ðŸ”„ å·¥ä½œæµç¨‹

### å®žæ—¶å¯¹è¯æµç¨‹
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
åŽç«¯å¯åŠ¨ graph.astream(["updates", "messages", "custom"])
  â†“
Redis Pub/Sub å‘å¸ƒäº‹ä»¶
  â”œâ”€ messages: Token æµå¼è¾“å‡º â†’ ç´¯ç§¯åˆ° assistant æ¶ˆæ¯
  â”œâ”€ updates: èŠ‚ç‚¹å®Œæˆäº‹ä»¶ â†’ åˆ›å»º node æ¶ˆæ¯
  â””â”€ custom: è‡ªå®šä¹‰è¿›åº¦(é¢„ç•™)
  â†“
å‰ç«¯ WebSocket æŽ¥æ”¶
  â”œâ”€ query_or_respond token â†’ åˆ›å»ºä¸´æ—¶ assistant æ¶ˆæ¯
  â”œâ”€ tools å®Œæˆ â†’ åˆ›å»º node æ¶ˆæ¯
  â””â”€ generate token â†’ ç§»é™¤ä¸´æ—¶æ¶ˆæ¯,åˆ›å»ºæœ€ç»ˆ assistant æ¶ˆæ¯
  â†“
å·¥ä½œæµå®Œæˆ â†’ æ•°æ®æŒä¹…åŒ–åˆ° PostgreSQL Checkpoint
```

### åŽ†å²æ¢å¤æµç¨‹
```
å‰ç«¯åˆ·æ–°/åˆ‡æ¢ä¼šè¯
  â†“
è°ƒç”¨ GET /threads/{thread_id}/history
  â†“
åŽç«¯æŸ¥è¯¢ PostgreSQL Checkpoint
  â†“
æå– user/assistant æ¶ˆæ¯
  â”œâ”€ ä½¿ç”¨æ•°æ®åº“åŽŸå§‹æ—¶é—´æˆ³(ç§’â†’æ¯«ç§’)
  â”œâ”€ è¿‡æ»¤æŽ‰ tool/system æ¶ˆæ¯
  â””â”€ æŒ‰æ—¶é—´æŽ’åº
  â†“
å‰ç«¯æŽ¥æ”¶æ¶ˆæ¯æ•°ç»„
  â”œâ”€ ä¸æ˜¾ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹
  â”œâ”€ æŒ‰æ—¶é—´æˆ³ç»„ç»‡ Turn
  â””â”€ æ¸²æŸ“æ¸…æ™°çš„å¯¹è¯åŽ†å²
```

---

## ðŸ› é—®é¢˜ä¿®å¤è®°å½•

### Bug #1: æ¸²æŸ“ä¸ä¸€è‡´
**çŽ°è±¡**: å®žæ—¶ 6 ä¸ªèŠ‚ç‚¹,åˆ·æ–°åŽ 10 ä¸ªèŠ‚ç‚¹
**åŽŸå› **: å‰ç«¯ä½¿ç”¨ LangSmith Trace é‡æž„åŽ†å²,åŒ…å«å†…éƒ¨èŠ‚ç‚¹(ChatOpenAI ç­‰)
**ä¿®å¤**: ç§»é™¤ Trace ä¾èµ–,ç›´æŽ¥åŠ è½½ user/assistant æ¶ˆæ¯

### Bug #2: æ—¶é—´æˆ³é‡ç½®
**çŽ°è±¡**: åˆ·æ–°åŽæ‰€æœ‰æ¶ˆæ¯æ—¶é—´å˜ä¸ºå½“å‰æ—¶é—´
**åŽŸå› **: å‰ç«¯é‡æ–°è®¡ç®—æ—¶é—´æˆ³(`Date.now() - index * 1000`)
**ä¿®å¤**: ä½¿ç”¨æ•°æ®åº“åŽŸå§‹æ—¶é—´æˆ³(`msg.timestamp * 1000`)

### Bug #3: Generate è¦†ç›–åŽ†å²å¯¹è¯
**çŽ°è±¡**: ç¬¬äºŒè½®å¯¹è¯çš„æœ€ç»ˆç­”æ¡ˆè¦†ç›–ç¬¬ä¸€è½®å¯¹è¯
**åŽŸå› **: è¿‡æ»¤é€»è¾‘ç§»é™¤æ‰€æœ‰æ²¡æœ‰ `nodeName` çš„ assistant æ¶ˆæ¯
**ä¿®å¤**: åªç§»é™¤æœ€åŽä¸€ä¸ª user æ¶ˆæ¯ä¹‹åŽçš„ä¸´æ—¶æ¶ˆæ¯

### Bug #4: åŽç«¯å¯åŠ¨å¤±è´¥
**çŽ°è±¡**: `ModuleNotFoundError: No module named 'utils.trace_cache'`
**åŽŸå› **: å¼•å…¥äº†ä¸å­˜åœ¨çš„ç¼“å­˜æ¨¡å—
**ä¿®å¤**: ç§»é™¤ trace_cache å¯¼å…¥å’Œä½¿ç”¨

### Bug #5: ç¼©è¿›é”™è¯¯
**çŽ°è±¡**: `IndentationError: unexpected indent`
**åŽŸå› **: åˆ é™¤ä»£ç æ—¶ç ´åäº†ç¼©è¿›ç»“æž„
**ä¿®å¤**: ä¿®æ­£ if è¯­å¥ç¼©è¿›

---

## ðŸ“ API æ–‡æ¡£

### GET /threads/{thread_id}/history
**ç”¨é€”**: èŽ·å–è½»é‡çº§å¯¹è¯åŽ†å²(å‰ç«¯é»˜è®¤)

**å“åº”**:
```json
{
  "thread_id": "thread_xxx",
  "messages": [
    {
      "id": "msg_1",
      "role": "user",
      "content": "ä½ å¥½",
      "timestamp": 1733587200.5  // æ•°æ®åº“åŽŸå§‹å€¼(ç§’)
    },
    {
      "id": "msg_2",
      "role": "assistant",
      "content": "ä½ å¥½!æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—?",
      "timestamp": 1733587201.8
    }
  ],
  "total_messages": 2
}
```

### GET /threads/{thread_id}/history-with-trace
**ç”¨é€”**: èŽ·å–å®Œæ•´åŽ†å²å« Trace(æŒ‰éœ€æŸ¥è¯¢)

**å“åº”**:
```json
{
  "thread_id": "thread_xxx",
  "messages": [...],  // åŒä¸Š
  "trace_runs": [...],  // æ‰€æœ‰ Trace Run
  "trace_tree": [...],  // æ ‘å½¢ç»“æž„
  "root_run_id": "run_xxx",
  "total_latency_ms": 2500,
  "total_tokens": 1234
}
```

---

## ðŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. Custom Stream Mode åº”ç”¨
```python
# åœ¨èŠ‚ç‚¹ä¸­æ·»åŠ è‡ªå®šä¹‰è¿›åº¦æç¤º
from langgraph.config import get_stream_writer

async def query_or_respond(state, config):
    writer = get_stream_writer()
    writer("æ­£åœ¨åˆ†æžæŸ¥è¯¢...")
    # ... å¤„ç†é€»è¾‘
    writer("åˆ†æžå®Œæˆ,å‡†å¤‡æ£€ç´¢...")
```

### 2. èŠ‚ç‚¹çŠ¶æ€ä¼˜åŒ–
- ç§»é™¤ `NodeStep` ä¸­çš„ `start` å’Œ `running` çŠ¶æ€(å·²åºŸå¼ƒ)
- ç®€åŒ–çŠ¶æ€æœº,åªä¿ç•™ `completed` å’Œ `error`

### 3. WebSocket ä¼˜åŒ–
- è€ƒè™‘ä½¿ç”¨ Server-Sent Events (SSE) æ›¿ä»£ WebSocket
- å‡å°‘è¿žæŽ¥ç®¡ç†å¤æ‚åº¦

### 4. æ€§èƒ½ç›‘æŽ§
- æ·»åŠ åŽ†å²åŠ è½½è€—æ—¶ç›‘æŽ§
- ç»Ÿè®¡ LangSmith API æŸ¥è¯¢é¢‘çŽ‡
- ä¼˜åŒ– Checkpoint æŸ¥è¯¢æ€§èƒ½

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- `DESIGN_LANGGRAPH_AGENTIC_RAG.md` - åŽŸå§‹ Agentic RAG è®¾è®¡
- `FRONTEND_MESSAGE_PERSISTENCE_ISSUE.md` - æ¶ˆæ¯æŒä¹…åŒ–é—®é¢˜åˆ†æž
- `src/api/routes/chat.py` - åŽç«¯æŽ¥å£å®žçŽ°
- `frontend/src/hooks/useChatStream.ts` - å‰ç«¯çŠ¶æ€ç®¡ç†
- `frontend/src/components/ChatWindow.tsx` - Turn ç»„ç»‡é€»è¾‘

---

## âœ… éªŒæ”¶æ¸…å•

- [x] å®žæ—¶æµå¼æ˜¾ç¤ºæ­£ç¡®(åªæ˜¾ç¤º completed äº‹ä»¶)
- [x] åŽ†å²åŠ è½½æ—¶é—´æˆ³å‡†ç¡®(ä½¿ç”¨æ•°æ®åº“å€¼)
- [x] åˆ·æ–°åŽä¸æ˜¾ç¤ºèŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹
- [x] å¤šè½®å¯¹è¯ä¸ä¼šäº’ç›¸è¦†ç›–
- [x] Generate èŠ‚ç‚¹æ­£ç¡®æ›¿æ¢ä¸­é—´ç»“æžœ
- [x] åŽç«¯å¯åŠ¨æ— é”™è¯¯
- [x] å‰ç«¯æ— å†—ä½™ console.log
- [x] ä»£ç ç®€æ´æ¸…æ™°,æ— å†—ä½™é€»è¾‘
- [x] API æ–‡æ¡£è¯´æ˜Žæ¸…æ™°å‡†ç¡®

---

**é‡æž„å®Œæˆæ—¥æœŸ**: 2025-12-07  
**ä»£ç è¡Œæ•°å‡å°‘**: 230 è¡Œ (-16%)  
**æ€§èƒ½æå‡**: åŽ†å²åŠ è½½å¿« 10 å€  
**ç»´æŠ¤æ€§**: æž¶æž„æ¸…æ™°,æ˜“äºŽç†è§£å’Œæ‰©å±•
